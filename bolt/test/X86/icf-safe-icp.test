## Check that BOLT handles correctly folding functions with --icf=safe that can be referenced.
## The compare is generated by the ICP path with instrumentation profiling.

# REQUIRES: system-linux
# RUN: llvm-mc -filetype=obj -triple x86_64-unknown-linux %s -o %t1.o
# RUN: %clang %cflags %t1.o -o %t.exe -Wl,-q
# RUN: llvm-bolt --no-threads %t.exe --icf      -debug -debug-only=bolt-icf -o %t.bolt 2>&1 | FileCheck --check-prefix=ICFCHECK %s
# RUN: llvm-bolt --no-threads %t.exe --icf=safe -debug -debug-only=bolt-icf -o %t.bolt 2>&1 | FileCheck --check-prefix=SAFEICFCHECK %s

# ICFCHECK:      ICF iteration 1
# ICFCHECK-NEXT: folding _ZNK8Derived34funcEii into _ZNK8Derived24funcEii
# ICFCHECK-NEXT: folding _ZN8Derived3D0Ev into _ZN8Derived2D0Ev

# SAFEICFCHECK:      skipping function _ZNK8Derived24funcEii
# SAFEICFCHECK-NEXT: skipping function _ZNK8Derived34funcEii
# SAFEICFCHECK-NEXT: ICF iteration 1
# SAFEICFCHECK-NEXT: folding _ZN8Derived3D0Ev into _ZN8Derived2D0Ev
# SAFEICFCHECK-NEXT: ===---------


## generate profile
## clang++ -O2 -fprofile-generate=. main.cpp   -c -o mainProf.o
## PROF=test.profdata
## clang++ -m64  -fprofile-use=$PROF \
##   -mllvm -disable-icp=true -mllvm -print-after-all \
##   -g0 -flto=thin -fwhole-program-vtables -fno-split-lto-unit -O2 \
##   -fdebug-types-section \
##   main.cpp -c -o mainProfLTO.bc
## PASS='pgo-icall-prom'
## clang++ -m64  -fprofile-use=$PROF \
##   -O3 -Rpass=$PASS \
##   -mllvm -print-before=$PASS \
##   -mllvm -print-after=$PASS \
##   -mllvm -filter-print-funcs=main \
##   -mllvm -debug-only=$PASS \
##   -x ir \
##   mainProfLTO.bc -c -o mainProfFinal.o

## class Base {
## public:
##   virtual int func(int a, int b) const = 0;
##
##   virtual ~Base() {};
## };
##
## //namespace {
## class Derived2 : public Base {
##   int c = 5;
## public:
##   __attribute__((noinline)) int func(int a, int b)const override { return a * (a - b) + this->c; }
##
##   ~Derived2() {}
## };
##
## class Derived3 : public Base {
##   int c = 500;
## public:
##   __attribute__((noinline)) int func(int a, int b) const override { return a * (a - b) + this->c; }
##   ~Derived3() {}
## };
## //} // namespace//
##
## __attribute__((noinline)) Base *createType(int a) {
##     Base *base = nullptr;
##     if (a == 4)
##       base = new Derived2();
##     else
##       base = new Derived3();
##     return base;
## }
##
## extern int returnFive();
## extern int returnFourOrFive(int val);
## int main(int argc, char **argv) {
##   int sum = 0;
##   int a = returnFourOrFive(argc);
##   int b = returnFive();
##   Base *ptr = createType(a);
##   Base *ptr2 = createType(b);
##   sum += ptr->func(b, a) + ptr2->func(b, a);
##   return 0;
## }
## clang++ -c helper.cpp -o helper.o
## int FooVar = 1;
## int BarVar = 2;
##
## int fooGlobalFuncHelper(int a, int b) {
##   return 5;
## }
## Manually modified to remove "extra" assembly.
	.section	.text.hot.,"ax",@progbits
	.globl	_Z10createTypei
	.type	_Z10createTypei,@function
_Z10createTypei:
	.cfi_startproc
	callq	_Znwm@PLT
	leaq	_ZTV8Derived2+16(%rip), %rcx
	leaq	_ZTV8Derived3+16(%rip), %rdx
	cmoveq	%rcx, %rdx
	retq
	.size	_Z10createTypei, .-_Z10createTypei
	.cfi_endproc


	.globl	_Z10returnFivev
	.type	_Z10returnFivev,@function
_Z10returnFivev:
	.cfi_startproc
	movl	$5, %eax
	retq
	.size	_Z10returnFivev, .-_Z10returnFivev
	.cfi_endproc

	.globl	returnFourOrFiveFunc
	.type	returnFourOrFiveFunc,@function
returnFourOrFiveFunc:
	.cfi_startproc
	xorl	%eax, %eax
	cmpl	$1, %edi
	sete	%al
	xorl	$5, %eax
	retq
	.size	returnFourOrFiveFunc, .-returnFourOrFiveFunc
	.cfi_endproc


	.globl	main
	.type	main,@function
main:
	.cfi_startproc
	callq	returnFourOrFiveFunc@PLT
	callq	_Z10returnFivev@PLT
	callq	_Z10createTypei
	callq	_Z10createTypei
	leaq	_ZNK8Derived24funcEii(%rip), %rcx
	callq	_ZNK8Derived24funcEii
	leaq	_ZNK8Derived34funcEii(%rip), %rcx
	callq	_ZNK8Derived34funcEii
	.size	main, .-main
	.cfi_endproc

	.section	.text.hot._ZNK8Derived24funcEii,"axG",@progbits,_ZNK8Derived24funcEii,comdat
	.weak	_ZNK8Derived24funcEii
	.type	_ZNK8Derived24funcEii,@function
_ZNK8Derived24funcEii:                  #
	.cfi_startproc
	imull	%esi, %eax
	retq
	.size	_ZNK8Derived24funcEii, .-_ZNK8Derived24funcEii
	.cfi_endproc

	.section	.text.unlikely._ZN8Derived2D0Ev,"axG",@progbits,_ZN8Derived2D0Ev,comdat
	.weak	_ZN8Derived2D0Ev
	.type	_ZN8Derived2D0Ev,@function
_ZN8Derived2D0Ev:
	.cfi_startproc
	movl	$16, %esi
	jmp	_ZdlPvm@PLT
	.size	_ZN8Derived2D0Ev, .-_ZN8Derived2D0Ev
	.cfi_endproc

	.section	.text.hot._ZNK8Derived34funcEii,"axG",@progbits,_ZNK8Derived34funcEii,comdat
	.weak	_ZNK8Derived34funcEii
	.type	_ZNK8Derived34funcEii,@function
_ZNK8Derived34funcEii:
	.cfi_startproc
	imull	%esi, %eax
	retq
	.size	_ZNK8Derived34funcEii, .-_ZNK8Derived34funcEii
	.cfi_endproc

	.section	.text.unlikely._ZN4BaseD2Ev,"axG",@progbits,_ZN4BaseD2Ev,comdat
	.weak	_ZN4BaseD2Ev
	.type	_ZN4BaseD2Ev,@function
_ZN4BaseD2Ev:
	.cfi_startproc
	retq
	.size	_ZN4BaseD2Ev, .-_ZN4BaseD2Ev
	.cfi_endproc

	.section	.text.unlikely._ZN8Derived3D0Ev,"axG",@progbits,_ZN8Derived3D0Ev,comdat
	.weak	_ZN8Derived3D0Ev
	.type	_ZN8Derived3D0Ev,@function
_ZN8Derived3D0Ev:
	.cfi_startproc
	movl	$16, %esi
	jmp	_ZdlPvm@PLT
	.size	_ZN8Derived3D0Ev, .-_ZN8Derived3D0Ev
	.cfi_endproc

	.type	_ZTV8Derived2,@object
	.section	.data.rel.ro._ZTV8Derived2,"awG",@progbits,_ZTV8Derived2,comdat
	.weak	_ZTV8Derived2
_ZTV8Derived2:
	.quad	0
	.quad	_ZTI8Derived2
	.quad	_ZNK8Derived24funcEii
	.quad	_ZN4BaseD2Ev
	.quad	_ZN8Derived2D0Ev
	.size	_ZTV8Derived2, 40

	.type	_ZTS8Derived2,@object
	.section	.rodata._ZTS8Derived2,"aG",@progbits,_ZTS8Derived2,comdat
	.weak	_ZTS8Derived2
_ZTS8Derived2:
	.asciz	"8Derived2"
	.size	_ZTS8Derived2, 10

	.type	_ZTS4Base,@object
	.section	.rodata._ZTS4Base,"aG",@progbits,_ZTS4Base,comdat
	.weak	_ZTS4Base
_ZTS4Base:
	.asciz	"4Base"
	.size	_ZTS4Base, 6

	.type	_ZTI4Base,@object
	.section	.data.rel.ro._ZTI4Base,"awG",@progbits,_ZTI4Base,comdat
	.weak	_ZTI4Base
_ZTI4Base:
	.quad	_ZTVN10__cxxabiv117__class_type_infoE+16
	.quad	_ZTS4Base
	.size	_ZTI4Base, 16

	.type	_ZTI8Derived2,@object
	.section	.data.rel.ro._ZTI8Derived2,"awG",@progbits,_ZTI8Derived2,comdat
	.weak	_ZTI8Derived2
_ZTI8Derived2:
	.quad	_ZTVN10__cxxabiv120__si_class_type_infoE+16
	.quad	_ZTS8Derived2
	.quad	_ZTI4Base
	.size	_ZTI8Derived2, 24

	.type	_ZTV8Derived3,@object
	.section	.data.rel.ro._ZTV8Derived3,"awG",@progbits,_ZTV8Derived3,comdat
	.weak	_ZTV8Derived3
_ZTV8Derived3:
	.quad	0
	.quad	_ZTI8Derived3
	.quad	_ZNK8Derived34funcEii
	.quad	_ZN4BaseD2Ev
	.quad	_ZN8Derived3D0Ev
	.size	_ZTV8Derived3, 40

	.type	_ZTS8Derived3,@object
	.section	.rodata._ZTS8Derived3,"aG",@progbits,_ZTS8Derived3,comdat
	.weak	_ZTS8Derived3
_ZTS8Derived3:
	.asciz	"8Derived3"
	.size	_ZTS8Derived3, 10

	.type	_ZTI8Derived3,@object
	.section	.data.rel.ro._ZTI8Derived3,"awG",@progbits,_ZTI8Derived3,comdat
	.weak	_ZTI8Derived3
_ZTI8Derived3:
	.quad	_ZTVN10__cxxabiv120__si_class_type_infoE+16
	.quad	_ZTS8Derived3
	.quad	_ZTI4Base
	.size	_ZTI8Derived3, 24
